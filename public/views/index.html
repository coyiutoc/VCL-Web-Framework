<!DOCTYPE html>
<html>
<head>
    <link rel="icon" href="./img/VCL_favicon.png">
    <title>VCL Web Framework</title>

    <!-- Scripts: -->  
    <script src="https://code.jquery.com/jquery-3.1.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>

    <!-- Style: -->
    <link rel="stylesheet" href="../styles/styles.css">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">

    <!-- Routing helper: -->
    <script type="text/javascript" src="/scripts/routing/conditions.js"></script>

</head>

  <body>
    <div class = "box">
      <img src="../img/VCL_favicon.png"></img>
      <br>
      <h1><b>Visual Cognition Lab</b></h1> 
      <hr>
      <form>
        <div class="form-row">
          <div class="form-group col-md-6">
            <label for="subjectID_input"><b>Subject ID:</b></label>
            <input type="text" class="form-control" id="subjectID_input" placeholder="---" style="text-align: center">
          </div>
          <div class="form-group col-md-6">
            <label for="subjectInitials_input"><b>Subject Initials:</b></label>
            <input type="text" class="form-control" id="subjectInitials_input" placeholder="---" style="text-align: center">
          </div>
        </div>
        <br>
        <div class = "form-row form-background">
          <div class = "form-group col-md-6">

            <div class = "form-row">
              <div class="form-group col-md-12">
                <label for="experiment-label"><b>Experiment:</b></label>
                <select id = "experiment-select" class="custom-select">
                  <option value="jnd" selected>JND</option>
                  <option value="jnd_radius">JND Radius</option>
                  <option value="stevens">Stevens</option>
                  <option value="estimation">Estimation</option>
                </select>
              </div>
            </div>

            <div class = "form-row">
              <div class="form-group col-md-12">
                <label for="trial-struct-label"><b>Trial Structure:</b></label>
                <select id = "trial-struct-select" class="custom-select">
                  <option value="foundational" selected>Foundational</option>
                  <option value="design">Design</option>
                  <option value="estimation">Estimation</option>
                  <option value="custom">Custom</option>
                </select>
              </div>
            </div>

            <div class = "form-row">
              <div class="form-group col-md-12">
                <label for="graph-label"><b>Graph Type:</b></label>
                <select id = "graph-select" class="custom-select">
                  <option value="scatter" selected>Scatter</option>
                  <option value="strip">Strip</option>
                  <option value="ring">Ring</option>
                  <option value="shapes">Shapes</option>
                </select>
              </div>
            </div>

          </div>
          <div class = "form-group col-md-6">
            <div class = "form-row">
              <div class="form-group col-md-12">
                <label for="sub-menu-label"><b>Supported Conditions:</b></label>
                <ul id = "conditions-list" class="sub-menu">
                </ul>
              </div>
            </div>
          </div>

        </div>

        <br>
        <div class="form-row">
          <div class="form-group col-md-12">
            <input id = "start" type="button" onclick="" class="form-control btn btn-success" style="display: block;" value = "S T A R T" disabled="true"></input>
          </div>
        </div>
      </form>
      <br>
      </div>
    </div>

  </body> 

  <script type = "module">

    import {CONDITIONS} from "/scripts/routing/conditions.js";

    var experiment = "jnd";
    var trial_structure = "foundational";
    var graph_type = "scatter";

    var DISPLAYED_CONDITIONS = {};

    var selected_elem = null;

    // Update the list on startup
    update_conditions_list();

    //////////////////////////////////////////////////////////
    // JQuery UI Change Events

    // Triggered on change of experiment selection drop down
    $('#experiment-select').change(function(){ 
        experiment = $(this).val();
        update_conditions_list();
    });

    // Triggered on change of trial structure drop down
    $('#trial-struct-select').change(function(){ 
        trial_structure = $(this).val();
        update_conditions_list();
    });

    // Triggered on change of graph type selection drop down
    $('#graph-select').change(function(){ 
        graph_type = $(this).val();
        update_conditions_list();
    });

    // Triggered on click of start button
    // Responsible for constructing the route 
    $( "#start").click(function(){

      let address = location.protocol + "//" + location.hostname + ":" + location.port;

      let condition_name = selected_elem.id;

      if (CONDITIONS[condition_name]){

        if (!CONDITIONS[condition_name]["experiment"].includes(experiment)){
          throw Error("Condition " + condition_name + " does not support experiment " + experiment);
        }

        if (!CONDITIONS[condition_name]["trial_structure"].includes(trial_structure)){
          throw Error("Condition " + condition_name + " does not support trial structure " + trial_structure);
        }

        if (!CONDITIONS[condition_name]["graph_type"].includes(graph_type)){
          throw Error("Condition " + condition_name + " does not support graph type " + graph_type);
        }

        address += `/experiment/${experiment}/graph_type/${graph_type}/trial_structure/${trial_structure}/condition/${condition_name}/balancing/${CONDITIONS[condition_name]["balancing"]}`;

        let subject_initials = document.getElementById("subjectInitials_input").value;
        let subject_id = document.getElementById("subjectID_input").value;

        if (!subject_initials){
          subject_initials = "test";
        }

        if (!subject_id){
          subject_id = "test";
        }

        address += `/subject_id/${subject_id}/subject_initials/${subject_initials}`;
        location.href = address;

      } else {
        throw Error("Condition name " + condition_name + " is not supported.");
      }

    });

    //////////////////////////////////////////////////////////
    // Helper functions

    // Will update the conditions displayed upon change on any of the dropdowns 
    function update_conditions_list(){

      // Iterate through every valid condition
      for (let key in CONDITIONS) {

          let condition = CONDITIONS[key];

          // If there is a valid condition matching the identifiers, append a li element for it
          if (check_condition(condition) && !DISPLAYED_CONDITIONS[key]) {

            $( "#conditions-list" ).append( `<li id = ${key}>${condition["display_name"]}</li>` );
            DISPLAYED_CONDITIONS[key] = condition;

            let elem = document.getElementById(key);

            // Adding a click event listener when an element is selected
            elem.addEventListener("click", function(){
              $("#start").attr("disabled", false);

              // If previously selected element is not the same as currently selected,
              // revert the highlight
              if (selected_elem && elem !== selected_elem) { 
                selected_elem.style.backgroundColor = "#ffffff";
              }

              elem.style.backgroundColor = "#ffbf80";
              selected_elem = elem; 

              });
          }
        }

      // Checking for all conditions displayed, they are all valid conditions
      // given the identifiers
      for (let key in DISPLAYED_CONDITIONS) {

        let condition = DISPLAYED_CONDITIONS[key];

        if (!check_condition(condition)){
          $(`#${key}`).remove();
          delete DISPLAYED_CONDITIONS[key];
        }
      }

      // If nothing displayed, disable the start button
      if (Object.keys(DISPLAYED_CONDITIONS).length === 0){
        $("#start").attr("disabled", true);
      }     

    }

    // Validates if a condition has the selected identifiers
    function check_condition(condition){
      if (experiment !== "" && !condition["experiment"].includes(experiment)){
        return false;
      } 

      if (trial_structure !== "" && !condition["trial_structure"].includes(trial_structure)){
        return false;
      }

      if (graph_type !== "" && !condition["graph_type"].includes(graph_type)){
        return false;
      }

      return true;
    }
   
  </script>

</html>