<!DOCTYPE html>
<html>
  <head>
    <title>VCL: JND Experiment</title>

    <!-- Scripts: -->
    
    <!-- JsPsych: -->
    <script src="../../../jspsych/jspsych.js"></script>
    <script src="../../../jspsych/plugins/jspsych-html-keyboard-response.js"></script>
    <script src="../../../jspsych/plugins/jspsych-image-keyboard-response.js"></script>
    <script src="../../../jspsych/plugins/jspsych-external-html.js"></script>
    <script src="../../../jspsych/plugins/jspsych-external-html-keyboard-response.js"></script>

    <!-- Local scripts: -->
    <script type="text/javascript" src="../../scripts/experiments/jnd.js" ></script>
    <script type="text/javascript" src="../../scripts/gaussian_distribution_generator.js" ></script> 
    <script type="text/javascript" src="../../scripts/experiment_helpers.js" ></script>
    <script type="text/javascript" src="../../scripts/latin_square_generator.js" ></script>
    <script type="text/javascript" src="../../scripts/gaussian.js" ></script>

    <!-- Math.js: -->
    <script type="text/javascript" src="https://unpkg.com/mathjs@4.4.2/dist/math.min.js"></script>

    <!-- D3: -->
    <script src = "https://d3js.org/d3.v4.min.js"></script>
    
    <!-- Style: -->
    <link href="../../../jspsych/css/jspsych.css" rel="stylesheet" type="text/css"></link>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

  </head>

  <body>
  </body>

  <script>

    // =========================================================
    // CONSTANTS

    const MATHJS_URL = "https://unpkg.com/mathjs@4.4.2/dist/math.min.js";

    var timeline = [];
    const localhost = "http://localhost:8080";

    // Variables used to generate D3 jnd_trial_display.html:
    var left_coordinates;
    var right_coordinates;
    var distribution_size; 

    var multiplier = 1; // Sets how much the data should be scaled by.

    // =========================================================
    // INSTANTIATE JND EXPERIMENT OBJECT

    const JND_EXCEL = [
      {base_correlation: 0.3, error: 0.0001, max_step_size: 0.01, converge_from_above: true, initial_difference: 0.1, num_points: 100, mean: 0.5, SD: 0.2, num_SD: 2.5},

      {base_correlation: 0.6, error: 0.0001, max_step_size: 0.01, converge_from_above: true, initial_difference: 0.1, num_points: 100, mean: 0.5, SD: 0.2, num_SD: 2.5},

      {base_correlation: 0.9, error: 0.0001, max_step_size: 0.01, converge_from_above: true, initial_difference: 0.1, num_points: 100, mean: 0.5, SD: 0.2, num_SD: 2.5}
    ];

    var jnd_exp = new JND("foundational"); 
    jnd_exp.prepare_experiment('latin_square', JND_EXCEL);

    // =========================================================
    // WELCOME TRIAL BLOCK

    var welcome = {
      type: 'html-keyboard-response',
      stimulus: '<div align = "center">' + '<img src="../img/VCL_lab_logo.png"></img> <br>' +
                'This is a <b>Proof of Concept</b> for a <b>Foundational JND Experiment</b>.' + 
                '<p><font size = 15>Press any key to begin.<p></font>' +
                '</div>',
      data: {type: 'instruction'}
    };
    timeline.push(welcome);

    // =========================================================
    // INSTRUCTION TRIAL BLOCKS

    var instructions = {
      type: "html-keyboard-response",
      stimulus: "<div align = 'center'> <p>In this experiment, two graphs will appear side-by-side." + 
          "<br> Indicate which graph is more correlated by pressing the Z or M key. </p><p>" +
          "<div style='height: 290px; width: 700px; display: block;'>"+
          "<div style='float: left;'><img src='../img/sample_scatter_1.png'></img>" +
          "<p class='small'><strong>Press the Z key</strong></p></div>" +
          "<div style='float: right;'><img src='../img/sample_scatter_2.png'></img>" +
          "<p class='small'><strong>Press the M key</strong></p></div>" +
          "</div>" + "<div> <br><p>Press any key to continue.</p> </div>" + 
          "</div>"          
    };

    var ready = {
      type: 'html-keyboard-response',
      stimulus: "<div align = 'center'> <font size = 20><p>Ready?<p>" + "<p><b>Press any key to begin.</b></p></font></div>",
      data: {type: 'instruction'}
    }

    var instruction_trials = {
      timeline: [instructions, ready]
    };

    timeline.push(instruction_trials);

    // =========================================================
    // EXPERIMENT TRIAL BLOCKS

    // ---------------------------------------------------------
    // FEEDBACK

    var feedback = {
      type: 'html-keyboard-response',
      choices: jsPsych.NO_KEYS, //No responses will be accepted as a valid response.
      trial_duration: 500,
      data: {type: 'feedback'},
      stimulus: function(){
        var last_trial = JSON.parse(jsPsych.data.getLastTrialData().json());
        var last_trial_correct = last_trial[0]["correct"];

        // For debugging purposes:
        if (last_trial_correct == -1){
          return '<p>' + 
                 '<font style="font-size:50px; color:blue">Exiting from experiment.<p></font>'
        }

        else if (last_trial_correct){
          return '<p><i class="fa fa-check-circle" style="font-size:50px; color:green; margin-right: 10px;"></i>' + 
                 '<font style="font-size:50px; color:green">Correct!<p></font>'
        }
        else{
          return '<p><i class="fa fa-close" style="font-size:50px; color:red; margin-right: 10px;"></i>' + 
                 '<font style="font-size:50px; color:red;"">Incorrect!<p></font>'
        }
      }
    };

    // ---------------------------------------------------------
    // JND

    var trial = {
      type:'external-html-keyboard-response',
      url: localhost + "/jnd_trial",
      choices:['z', 'm', 'q'], //q is exit button (for debugging)
      execute_script: true,
      response_ends_trial: true,
      data: jnd_exp.trial_variables,
      on_start: function(trial){ // NOTE: on_start takes in trial var 

        // Set the constants to be used:
        var index = jnd_exp.current_sub_condition_index;
        var constants = jnd_exp.sub_conditions_constants[index];

        // For the first trial, we need to initialize the adjusted correlation:
        if (jsPsych.data.get().last(1).values()[0].type == "instruction"){
          var adjusted_correlation = jnd_exp
                                    .initialize_adjusted_statistic(constants.converge_from_above,
                                                                   constants.base_correlation,
                                                                   constants.initial_difference);

        }
        else{
          var last_JND_trial = jsPsych.data.get().filter({type: "jnd"}).last(1).values()[0];

          var adjusted_correlation = jnd_exp
                                     .get_next_adjusted_statistic(last_JND_trial.correct,
                                                                  constants.converge_from_above,
                                                                  last_JND_trial.adjusted_correlation,
                                                                  constants.base_correlation,
                                                                  constants.initial_difference,
                                                                  constants.max_step_size);
        }

        // Handling saving the data: 
        trial.data.adjusted_correlation = adjusted_correlation;
        jnd_exp.adjusted_quantity_matrix[index].push(adjusted_correlation);
        trial.data.jnd_value = Math.abs(adjusted_correlation - constants.base_correlation);

        // Generate distributions
        var base_coordinates = generateDistribution(constants.base_correlation, 
                                                    constants.error, 
                                                    constants.num_points, 
                                                    constants.num_SD, 
                                                    constants.mean, 
                                                    constants.SD);

        var adjusted_coordinates = generateDistribution(adjusted_correlation, 
                                                        constants.error, 
                                                        constants.num_points, 
                                                        constants.num_SD, 
                                                        constants.mean,
                                                        constants.SD);

        // Randomize position of the base and adjusted graphs
        var result = randomize_position(trial, 
                                       base_coordinates,
                                       adjusted_coordinates, 
                                       constants.base_correlation, 
                                       adjusted_correlation);
        // For testing purposes, can force R graph to have greater correlation
        // var result = force_greater_right_position(trial,
        //                                           base_coordinates,
        //                                           adjusted_coordinates,
        //                                           constants.base_correlation,
        //                                           adjusted_correlation);

        left_coordinates = result.left;
        right_coordinates = result.right;
        distribution_size = constants.num_points;   

        console.log("[RIGHT] Correlation: " + trial.data.right_correlation);
        console.log("[LEFT] Correlation: " + trial.data.left_correlation);

      },
      on_finish: function(data){ // NOTE: on_finish takes in data var 
        check_response(data);
        console.log("RESPONSE: " + data.correct);
      } 
    };

    // =========================================================
    // EXPERIMENT BLOCK

    var experiment = {
      timeline: [trial, feedback],
      loop_function: function(data){ // Return true if timeline should continue
                                     // Return false if timeline should end

        // For debugging, if you want to exit out of experiment, press q:
        if (jsPsych.pluginAPI.convertKeyCharacterToKeyCode('q') == data.values()[0].key_press){
          return false;
        }

        // If subcondition should end:
        if(jnd_exp.end_sub_condition()){
          // If there are still more subconditions, increment current index
          if (jnd_exp.current_sub_condition_index < (jnd_exp.sub_conditions_constants.length-1)){
            jnd_exp.current_sub_condition_index++; 
            console.log("!!!!!!!!!! Moved to new sub condition at index " 
                        + jnd_exp.current_sub_condition_index);
            return true; 
          }
          // Else end experiment
          else{
            return false;
          }
        } 
        // Else continue w/ current subcondition:
        else {
          return true;
        }
      }
    };

    timeline.push(experiment);

    console.log("======================");
    
    // =========================================================
    // START JSPSYCH

    jsPsych.init({
        timeline: timeline,
        on_finish: function(){ 
            jsPsych.data.displayData();
            console.log(jnd_exp.adjusted_quantity_matrix);
        }
    });

  </script>
</html>
