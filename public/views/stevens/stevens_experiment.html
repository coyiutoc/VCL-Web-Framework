<!DOCTYPE html>
<html>
  <head>
    <title>VCL: Stevens Experiment</title>

    <!-- Scripts: -->
    
    <!-- JsPsych: -->
    <script src="../../../jspsych/jspsych.js"></script>
    <script src="../../../jspsych/plugins/jspsych-html-keyboard-response.js"></script>
    <script src="../../../jspsych/plugins/jspsych-image-keyboard-response.js"></script>
    <script src="../../../jspsych/plugins/jspsych-external-html.js"></script>
    <script src="../../../jspsych/plugins/jspsych-external-html-keyboard-response.js"></script>

    <!-- Local scripts: -->
    <script type="text/javascript" src="../../scripts/experiments/stevens.js" ></script>
    <script type="text/javascript" src="../../scripts/gaussian_distribution_generator.js" ></script> 
    <script type="text/javascript" src="../../scripts/experiment_helpers.js" ></script>
    <script type="text/javascript" src="../../scripts/latin_square_generator.js" ></script>
    <script type="text/javascript" src="../../scripts/gaussian.js" ></script>

    <!-- Math.js: -->
    <script type="text/javascript" src="https://unpkg.com/mathjs@4.4.2/dist/math.min.js"></script>

    <!-- D3: -->
    <script src = "https://d3js.org/d3.v4.min.js"></script>
    
    <!-- Style: -->
    <link href="../../../jspsych/css/jspsych.css" rel="stylesheet" type="text/css"></link>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

  </head>

  <body>
  </body>

  <script>

    // =========================================================
    // CONSTANTS

    const MATHJS_URL = "https://unpkg.com/mathjs@4.4.2/dist/math.min.js";

    var timeline = [];
    const localhost = "http://localhost:8080";

    // Variables used to generate D3 stevens_trial_display.html:
    var left_coordinates;
    var right_coordinates;
    var middle_coordinates;

    var multiplier = 1; // Sets how much the data should be scaled by.

    // =========================================================
    // INSTANTIATE STEVENS EXPERIMENT OBJECT

    const STEVENS_EXCEL = [
      {round_type: 'test', trials_per_round: 4, high_ref: 1, low_ref: 0, error: 0.0001, num_points: 100, regen_rate: 1000, mean: 0.5, SD: 0.2, num_SD: 2.5},

      {round_type: 'test', trials_per_round: 4, high_ref: 0.5, low_ref: 0, error: 0.0001, num_points: 100, regen_rate: 1000, mean: 0.5, SD: 0.2, num_SD: 2.5},

      {round_type: 'test', trials_per_round: 4, high_ref: 1, low_ref: 0.5, error: 0.0001, num_points: 100, regen_rate: 1000, mean: 0.5, SD: 0.2, num_SD: 2.5},

      {round_type: 'test', trials_per_round: 4, high_ref: 0.25, low_ref: 0, error: 0.0001, num_points: 100, regen_rate: 1000, mean: 0.5, SD: 0.2, num_SD: 2.5}
    ];

    var stevens_exp = new stevens("foundational"); 
    stevens_exp.prepare_experiment('latin_square', STEVENS_EXCEL);

    // =========================================================
    // WELCOME TRIAL BLOCK

    var welcome = {
      type: 'html-keyboard-response',
      stimulus: '<div align = "center">' + '<img src="../img/VCL_lab_logo.png"></img> <br>' +
                'This is a <b>Proof of Concept</b> for a <b>Foundational Stevens Experiment</b>.' + 
                '<p><font size = 15>Press any key to begin.<p></font>' +
                '</div>',
      data: {type: 'instruction'}
    };
    timeline.push(welcome);

    // =========================================================
    // INSTRUCTION TRIAL BLOCKS

    var instructions = {
      type: "html-keyboard-response",
      stimulus: "<div align = 'center'> <p>In this experiment, you will be using the <b>up</b>" +
          " and <b>down</b> keys to adjust the center graph <br> so that the correlation is roughly" +
          " the <u>midpoint</u> between the left and right graphs. <br>" +
          "<div style='float: left;'><img src='../img/sample_stevens.png'></img></div>" +
          "<br> <br> Press any key to continue. </div>"          
    };

    var ready = {
      type: 'html-keyboard-response',
      stimulus: "<div align = 'center'> <font size = 20><p>Ready?<p>" + "<p><b>Press any key to begin.</b></p></font></div>",
      data: {type: 'instruction'}
    }

    var instruction_trials = {
      timeline: [instructions, ready]
    };

    timeline.push(instruction_trials);

    // =========================================================
    // EXPERIMENT TRIAL BLOCK

    var trial = {
      type:'external-html-keyboard-response',
      url: localhost + "/stevens_trial",
      choices:[38, 40, 'q'], //38 = up, 40 = down, q is exit button (for debugging)
      execute_script: true,
      response_ends_trial: false,
      trial_duration: 1000, 
      data: stevens_exp.trial_variables,
      on_start: function(trial){ // NOTE: on_start takes in trial var 

        // Force reset that input_count and trial_num = 0
        // !!! For some reason, the previous trial's is carrying over...
        trial.data.input_count = 0;
        trial.data.trial_num = 0; 

        // Set the constants to be used:
        var index = stevens_exp.current_sub_condition_index;
        var constants = stevens_exp.sub_conditions_constants[index];

        // Retrieve data from last trial:
        var last_stevens_trial;

        if (jsPsych.data.get().filter({type: "stevens", sub_condition_index: index}).last(1).values()[0]){
          last_stevens_trial = jsPsych.data.get().filter({type: "stevens", sub_condition_index: index}).last(1).values()[0];
        }
        else{
          last_stevens_trial = null;
        }

        // Set the estimated correlation
        var estimated_correlation = stevens_exp.update_estimated_correlation(trial, constants, last_stevens_trial);

        // Handling saving the data: 
        trial.data.estimated_correlation = estimated_correlation;
        trial.data.sub_condition_index = index;

        // If trial is still part of same sub-condition, add onto trial num
        // and carry over step size (it is constant throughout sub conditions)
        if (last_stevens_trial){
          trial.data.trial_num = last_stevens_trial.trial_num + 1;
          trial.data.step_size = last_stevens_trial.step_size;
        }
        else{
          trial.data.trial_num = 1;
        }

        console.log("trial num: " + trial.data.trial_num);

        // Generate distributions
        var high_coordinates = generateDistribution(constants.high_ref, 
                                                    constants.error, 
                                                    constants.num_points, 
                                                    constants.num_SD, 
                                                    constants.mean, 
                                                    constants.SD);

        var low_coordinates = generateDistribution(constants.low_ref, 
                                                   constants.error, 
                                                   constants.num_points, 
                                                   constants.num_SD, 
                                                   constants.mean,
                                                   constants.SD);

        var estimated_coordinates = generateDistribution(estimated_correlation, 
                                                      constants.error, 
                                                      constants.num_points, 
                                                      constants.num_SD, 
                                                      constants.mean, 
                                                      constants.SD);

        // Randomize position of the base and adjusted graphs
        var result = randomize_position(trial, 
                                       high_coordinates,
                                       low_coordinates, 
                                       constants.high_ref, 
                                       constants.low_ref);

        left_coordinates = result.left;
        right_coordinates = result.right; 
        middle_coordinates = estimated_coordinates;  
        distribution_size = constants.num_points; 

        console.log("[RIGHT] Correlation: " + trial.data.right_correlation);
        console.log("[MIDPOINT] Correlation: " + trial.data.estimated_correlation);
        console.log("[LEFT] Correlation: " + trial.data.left_correlation);
      }
    };

    // =========================================================
    // EXPERIMENT BLOCK

    var experiment = {
      timeline: [trial],
      loop_function: function(data){ // Return true if timeline should continue
                                     // Return false if timeline should end

        // For debugging, if you want to exit out of experiment, press q:
        if (jsPsych.pluginAPI.convertKeyCharacterToKeyCode('q') == data.values()[0].key_press){
          return false;
        }

        // If subcondition should end:
        if(stevens_exp.end_sub_condition()){
          // If there are still more subconditions, increment current index
          if (stevens_exp.current_sub_condition_index < (stevens_exp.sub_conditions_constants.length-1))
          { 
            stevens_exp.current_sub_condition_index++; 
            console.log("!!!!!!!!!! Moved to new sub condition at index " 
                         + stevens_exp.current_sub_condition_index);
            return true; 
          }
          // Else end experiment
          else{
            return false;
          }
        } 
        // Else continue w/ current subcondition:
        else {
          return true;
        }
      }
    };

    timeline.push(experiment);

    console.log("======================");
    
    // =========================================================
    // START JSPSYCH

    jsPsych.init({
        timeline: timeline,
        on_finish: function(){ 
            jsPsych.data.displayData();
        }
    });

  </script>
</html>
