<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../../../">
  <title data-ice="title">scripts/experiment-properties/distribution/gaussian_distribution_generator.js | VCL Framework</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  <script src="script/manual.js"></script>
<script src="./inject/script/0-conditions-config.js"></script><script src="./inject/script/0-experiments-config.js"></script><script src="./inject/script/0-graphing-config.js"></script><script src="./inject/script/0-trial-structure-config.js"></script><script src="./inject/script/0-balancing-config.js"></script><script src="./inject/script/0-view-controller.js"></script><script src="./inject/script/0-experiments-renderer.js"></script><script src="./inject/script/0-conditions-renderer.js"></script><script src="./inject/script/0-supported-properties-renderer.js"></script><link rel="stylesheet" href="./inject/css/0-styles.css"><meta name="description" content="This is a Node.js application that runs proof of concept experiments for the following:"><meta property="twitter:card" content="summary"><meta property="twitter:title" content="VCL Framework"><meta property="twitter:description" content="This is a Node.js application that runs proof of concept experiments for the following:"></head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
<a style="position:relative; top:3px;" href="https://github.com/coyiutoc/VCL_Correlation_POC"><img width="20px" src="./image/github.png"></a></header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#experiment-properties-balancing">experiment-properties/balancing</a><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-balance_subconditions">balance_subconditions</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#experiment-properties-balancing-generators">experiment-properties/balancing/generators</a><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-initialize_latin_square">initialize_latin_square</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-initialize_random_order">initialize_random_order</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#experiment-properties-data">experiment-properties/data</a><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-get_subconditions">get_subconditions</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-create_condition_dataset">create_condition_dataset</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-get_data">get_data</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-get_data_subset">get_data_subset</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-CUSTOM_TRIAL_STRUCTURE_CONDITIONS">CUSTOM_TRIAL_STRUCTURE_CONDITIONS</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-EXPERIMENT_BASES">EXPERIMENT_BASES</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-EXPERIMENT_CONDITIONS">EXPERIMENT_CONDITIONS</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#experiment-properties-data-constants">experiment-properties/data/constants</a><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-ESTIMATION_BASE">ESTIMATION_BASE</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-JND_BASE">JND_BASE</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-JND_CONDITIONS">JND_CONDITIONS</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-JND_RADIUS_BASE">JND_RADIUS_BASE</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-JND_RADIUS_CONDITIONS">JND_RADIUS_CONDITIONS</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-STEVENS_BASE">STEVENS_BASE</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-STEVENS_CONDITIONS">STEVENS_CONDITIONS</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#experiment-properties-graphing">experiment-properties/graphing</a><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-is_custom_plot">is_custom_plot</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-prepare_custom_plot">prepare_custom_plot</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-plot_distributions">plot_distributions</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#experiment-properties-graphing-d3-base-plots">experiment-properties/graphing/d3-base-plots</a><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-create_ring_plot">create_ring_plot</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-create_scatter_plot">create_scatter_plot</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-plot_scatter_points">plot_scatter_points</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-create_shape_plot">create_shape_plot</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-create_strip_plot">create_strip_plot</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#experiment-properties-graphing-d3-custom-plots">experiment-properties/graphing/d3-custom-plots</a><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-create_distractor_scatter_plot">create_distractor_scatter_plot</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#experiments-estimation">experiments/estimation</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/scripts/experiments/estimation/estimation.js~Estimation.html">Estimation</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-estimation_exp">estimation_exp</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#experiments-jnd">experiments/jnd</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/scripts/experiments/jnd/jnd.js~JND.html">JND</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-jnd_exp">jnd_exp</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#experiments-jnd-radius">experiments/jnd_radius</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/scripts/experiments/jnd_radius/jnd_radius.js~JND_Radius.html">JND_Radius</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-jnd_radius_exp">jnd_radius_exp</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#experiments-stevens">experiments/stevens</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/scripts/experiments/stevens/stevens.js~Stevens.html">Stevens</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-stevens_exp">stevens_exp</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#helpers">helpers</a><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-force_greater_right_position">force_greater_right_position</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-randomize_position">randomize_position</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-randomize_radius_position">randomize_radius_position</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">scripts/experiment-properties/distribution/gaussian_distribution_generator.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">const TRIAL_LIMIT = 250;

function generateDistribution(correlation, error, size, numsd, mean, sd){

  // dynamicallyLoadScript(MATHJS_URL);
  var coordinates = {x_values: [], y_values: []};
  var overshootSize = size + 20; // Generating &gt; size will guarantee we have
                                 // a distribution of the speciied size later. 

  var done = true;
  // Initialize the points and make sure the correlation is in an acceptable error range.
  // Restart from scratch if adjusting for the error value is taking too long.
  do {
      // Reset coordinates:
      coordinates = {x_values: [], y_values: []};

      initializePoints(coordinates, correlation, overshootSize, numsd, mean, sd);
      done = adjustPointsForError(coordinates, correlation, error, overshootSize, numsd, mean, sd);
  } while(done == false);

  // Transformation into range [0, 1]
  transformPoints(coordinates, mean, sd);
  readjustPoints(coordinates, correlation, error, overshootSize, numsd, mean, sd);

  // Since this is code ported from the java codebase, coordinates are plotted
  // so that origin as at the top left (this makes the distribution negative instead
  // of positive). To force it to be positive, we flip the whole distribution 
  // across y axis. 
  for (i = 0; i&lt;coordinates.y_values.length; i++) {
    coordinates.y_values[i] = coordinates.y_values[i] * (-1);
  }

  let prepared_coordinates = prepare_coordinates(coordinates, size);
  return prepared_coordinates; 
}

/**
* Converts the coordinates into this format for d3:
* [ [x1, y1], [x2, y2] ... [xn, yn] ]
* And samples the distribution for the specified num_points.
*
* @param coordinates { {x_values: [], y_values: []} }
*        num_points {integer}
* @return output_coordinates { [x1, y1], [x2, y2] ... }
*/
function prepare_coordinates(coordinates, num_points){

  var array = [];
  var reorganized_coordinates = [];

  for (let i = 0; i &lt; coordinates.x_values.length; i++){
    array.push(coordinates.x_values[i]);
    array.push(coordinates.y_values[i]);

    reorganized_coordinates.push(array);
    array = [];
  }
  
  var output_coordinates = sample_coordinates(reorganized_coordinates, num_points);

  return output_coordinates;
}

/**
* Randomly picks x number of points from the distribution
* where x = num_points.
*
* @param coordinates { [x1, y1], [x2, y2] ... }
*        num_points {integer}
* @return output_coordinates with size num_points { [x1, y1], [x2, y2] ... }
*/
function sample_coordinates(coordinates, num_points){
  var output_coordinates = [];

  for (let i = num_points; i &gt; 0; i-- ) {
    var random_coordinate = coordinates.splice(Math.floor(Math.random() * (i + 1)), 1)[0];
    output_coordinates.push(random_coordinate);
  }

  return output_coordinates;
}

function initializePoints(coordinates, correlation, size, numsd, mean, sd){
  var xVal;
  var x2Val;
  var yVal;

  for (i = 0; i &lt; size; i++) {
    do {
        xVal = random_bm();
        x2Val = random_bm();

        // formula for generating gaussian distribution: y = p*x + sqrt(1-p^2)*(x2)
        yVal = (correlation * xVal) + (Math.sqrt(1 - (correlation * correlation)) * x2Val);
    } while (pointNotWithinRequiredStdDevs(xVal, yVal, numsd));

    coordinates.x_values.push(xVal);
    coordinates.y_values.push(yVal);
  }
}

function adjustPointsForError(coordinates, correlation, error, size, numsd, mean, sd) {

  var currTrial = 0;

  // Try to correct the correlation value, up to a maximum of TRIAL_LIMIT trials.
  while (correlationNotWithinError(coordinates, correlation, error) &amp;&amp; (currTrial &lt; TRIAL_LIMIT)) {
    currTrial += 1;
    coordinates.x_values.splice(size - 1, 1);
    coordinates.y_values.splice(size - 1, 1);
    var x;
    var x2;
    var y;
    do {
      x = random_bm();
      x2 = random_bm();
      y = (correlation * x) + (Math.sqrt(1 - (correlation * correlation)) * x2);
    } while (pointNotWithinRequiredStdDevs(x, y, numsd));
    coordinates.x_values.push(x);
    coordinates.y_values.push(y);
  }
  return !(correlationNotWithinError(coordinates, correlation, error));
}

// Replaces the points that are outside of the [0,1] range.
function readjustPoints(coordinates, correlation, error, size, numsd, mean, sd) {
  
  var temp_coordinates = {x_values: [], y_values: []};
  var max_iterations = 500;

  for (i = 0; i&lt;size; i++) {
    if (pointNotWithinRequiredStdDevs(coordinates.x_values[i], coordinates.y_values[i], numsd, mean, sd)){
      coordinates.x_values.splice(i, 1);
      coordinates.y_values.splice(i, 1);
      var x;
      var x2;
      var y;

      var temp = 0;
      while (temp &lt; max_iterations){
        x = random_bm();
        x2 = random_bm();
        y = (correlation * x) + (Math.sqrt(1 - (correlation * correlation)) * x2);
        x = x*sd + mean;
        y = y*sd + mean;

        if (i &gt; 0) {
          temp_coordinates.x_values = coordinates.x_values[i-1];
          temp_coordinates.y_values = coordinates.y_values[i-1];
          temp_coordinates.x_values[i] = x;
          temp_coordinates.y_values[i] = y;
        }

        if (!pointNotWithinRequiredStdDevs(x, y, numsd, mean, sd) &amp;&amp; (i &gt; 0) &amp;&amp;
            !correlationNotWithinError(temp_coordinates, correlation, error)){
          break;
        }

        temp++; 
      }

      coordinates.x_values[i] = x;
      coordinates.y_values[i] = y;
    }
  }

  /*
  If, after replacing the points, the correlation is outside of the error thresholds, regenerate the entire
  distribution
   */
  //if (correlationNotWithinError(coordinates, correlation, error)) {
    //coordinates = {x_values: [], y_values: []};
    //generateDistribution(correlation, error, size, numsd, mean, sd);
  //}
}

function pointNotWithinRequiredStdDevs(x, y, numsd){
  return pointNotWithinRequiredStdDevs2(x, y, numsd, 0, 1);
}

function pointNotWithinRequiredStdDevs(x, y, numsd, mean, sd){

  var leftThreshold = mean - numsd*sd;
  var rightThreshold = mean + numsd*sd;

  return (x &lt; leftThreshold) || (x &gt; rightThreshold) || (y &lt; leftThreshold) || (y &gt; rightThreshold);
}

function correlationNotWithinError(coordinates, correlation, error){
  return Math.abs(correlation - getPearsonCorrelation(coordinates.x_values, coordinates.y_values)) &gt; error;
}

function transformPoints(coordinates, mean, sd) {

    /** Calculate the needed x- and y- scale/translation amount
     * by using the formulas for:
     *         mean change: newMeanX = scaleX*meanX+translateX
     *             stdev change: newStdevX = scaleX*stdevX
     */
    var scaleX = sd/math.std(coordinates.x_values);
    var scaleY = sd/math.std(coordinates.y_values);
    var translateX = mean - math.mean(coordinates.x_values)*scaleX;
    var translateY = mean - math.mean(coordinates.y_values)*scaleY;
    scalePoints(coordinates,scaleX,scaleY);
    translatePoints(coordinates,translateX,translateY);
}

// Scales the points in a distribution with the given x and y scale values.
function scalePoints(coordinates, scaleX, scaleY) {
  for (i = 0; i&lt;coordinates.x_values.length; i++) {
    coordinates.x_values[i] = coordinates.x_values[i] * scaleX;
    coordinates.y_values[i] = coordinates.y_values[i] * scaleY;
  }
}

// Translates the points in a distribution with the given x and y translate values.
function translatePoints(coordinates, x, y) {
  for (i = 0; i&lt;coordinates.x_values.length; i++) {
    coordinates.x_values[i] = coordinates.x_values[i] + x;
    coordinates.y_values[i] = 1 - (coordinates.y_values[i] + y);
  }
}

// Returns Pearson Correlation Coefficient.
// SOURCE: https://memory.psych.mun.ca/tech/js/correlation.shtml
function getPearsonCorrelation(x, y) {
  var shortestArrayLength = 0;
   
  if(x.length == y.length) {
      shortestArrayLength = x.length;
  } else if(x.length &gt; y.length) {
      shortestArrayLength = y.length;
      console.error(&apos;x has more items in it, the last &apos; + (x.length - shortestArrayLength) + &apos; item(s) will be ignored&apos;);
  } else {
      shortestArrayLength = x.length;
      console.error(&apos;y has more items in it, the last &apos; + (y.length - shortestArrayLength) + &apos; item(s) will be ignored&apos;);
  }

  var xy = [];
  var x2 = [];
  var y2 = [];

  for(var i=0; i&lt;shortestArrayLength; i++) {
      xy.push(x[i] * y[i]);
      x2.push(x[i] * x[i]);
      y2.push(y[i] * y[i]);
  }

  var sum_x = 0;
  var sum_y = 0;
  var sum_xy = 0;
  var sum_x2 = 0;
  var sum_y2 = 0;

  for(var i=0; i&lt; shortestArrayLength; i++) {
      sum_x += x[i];
      sum_y += y[i];
      sum_xy += xy[i];
      sum_x2 += x2[i];
      sum_y2 += y2[i];
  }

  var step1 = (shortestArrayLength * sum_xy) - (sum_x * sum_y);
  var step2 = (shortestArrayLength * sum_x2) - (sum_x * sum_x);
  var step3 = (shortestArrayLength * sum_y2) - (sum_y * sum_y);
  var step4 = Math.sqrt(step2 * step3);
  var answer = step1 / step4;

  return answer;
}

// SOURCE: https://stackoverflow.com/questions/25582882/javascript-math-random-normal-distribution-gaussian-bell-curve?utm_medium=organic&amp;utm_source=google_rich_qa&amp;utm_campaign=google_rich_qa
function random_bm() {
  var u = 0, v = 0;
  while(u === 0) u = Math.random(); //Converting [0,1) to (0,1)
  while(v === 0) v = Math.random();
  return Math.sqrt( -2.0 * Math.log( u ) ) * Math.cos( 2.0 * Math.PI * v );
}

function dynamicallyLoadScript(url) {
  var script = document.createElement(&quot;script&quot;); // Make a script DOM node
  script.src = url; // Set it&apos;s src to the provided URL

  document.head.appendChild(script); // Add it to the end of the head section of the page (could change &apos;head&apos; to &apos;body&apos; to add it to the end of the body section instead)
}</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(1.1.0)</span><img src="./image/esdoc-logo-mini-black.png"></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
